---
import { TWIKOO } from "@consts";

type Props = {
  title?: string;
  envId?: string;
  region?: string;
  lang?: string;
  elId?: string;
  path?: string;
};

const {
  title = "评论",
  envId = TWIKOO.ENV_ID,
  region = TWIKOO.REGION || undefined,
  lang = TWIKOO.LANG || undefined,
  elId = TWIKOO.EL_ID,
  path,
} = Astro.props;
---

{envId && (
  <section class="animate mt-16 pt-10 border-t border-black/10 dark:border-white/15">
    <div class="mb-4 text-lg font-semibold text-black dark:text-white">
      {title}
    </div>
    <div
      id={`${elId}-status`}
      class="mb-3 text-sm text-black/60 dark:text-white/60"
    >
      正在加载评论…
    </div>
    <div id={elId} />
    <script is:inline define:vars={{ envId, region, lang, elId, path }}>
      (function () {
        window.__twikooAstro = window.__twikooAstro || {
          loading: null,
          hooked: false,
          config: null,
        };

        window.__twikooAstro.config = { envId, region, lang, elId, path };

        function setStatus(message) {
          var statusEl = document.getElementById(elId + "-status");
          if (!statusEl) return;
          statusEl.textContent = message || "";
          if (!message) statusEl.style.display = "none";
          else statusEl.style.display = "";
        }

        function loadScript(src) {
          return new Promise(function (resolve, reject) {
            var script = document.createElement("script");
            script.src = src;
            script.async = true;
            script.onload = function () {
              resolve();
            };
            script.onerror = function () {
              reject(new Error("Failed to load script: " + src));
            };
            document.head.appendChild(script);
          });
        }

	        function ensureTwikooStyles() {
	          var existing = document.getElementById("twikoo-style");
	          if (existing) return Promise.resolve();

          return new Promise(function (resolve) {
	            var link = document.createElement("link");
	            link.id = "twikoo-style";
	            link.rel = "stylesheet";
	            link.href =
	              "https://cdn.jsdelivr.net/npm/twikoo@1.6.39/dist/twikoo.min.css";
	            link.onload = function () {
	              resolve();
	            };
	            link.onerror = function () {
	              link.onerror = null;
	              link.onload = function () {
	                resolve();
	              };
	              link.href = "https://unpkg.com/twikoo@1.6.39/dist/twikoo.css";
	            };
	            document.head.appendChild(link);
	          });
	        }

        function isTwikooExport(value) {
          if (!value) return false;
          if (typeof value === "function") return true;
          if (typeof value === "object") {
            return (
              typeof value.init === "function" || typeof value.default === "function"
            );
          }
          return false;
        }

	        async function loadTwikoo() {
	          if (isTwikooExport(window.twikoo)) return;
	          if (window.__twikooAstro.loading) return window.__twikooAstro.loading;

	          window.__twikooAstro.loading = (async function () {
	            var sources = [
	              "https://cdn.jsdelivr.net/npm/twikoo@1.6.39/dist/twikoo.all.min.js",
	              "https://unpkg.com/twikoo@1.6.39/dist/twikoo.all.min.js",
	            ];

	            var lastErr = null;
	            for (var i = 0; i < sources.length; i++) {
	              try {
	                await loadScript(sources[i]);
	                return;
	              } catch (err) {
	                lastErr = err;
	              }
	            }
	            throw lastErr || new Error("Failed to load twikoo");
	          })();

	          return window.__twikooAstro.loading;
	        }

	        async function initTwikoo() {
	          var config = window.__twikooAstro.config;
	          if (!config || !config.envId) {
	            setStatus("未配置 Twikoo：请在 src/consts.ts 里填写 TWIKOO.ENV_ID");
	            return;
	          }
	          var mountEl = document.getElementById(config.elId);
	          if (!mountEl) return;
	          if (mountEl.dataset.twikooMounting === "1") return;
	          if (mountEl.dataset.twikooMounted === "1") return;

	          setStatus("正在加载评论…");
	          mountEl.dataset.twikooMounting = "1";
	          mountEl.innerHTML = "";

	          try {
	            await ensureTwikooStyles();
	            await loadTwikoo();

	            var tw = window.twikoo;
	            if (!isTwikooExport(tw)) {
	              throw new Error(
	                "twikoo is not available on window (or overridden by an element id); " +
	                  "try changing TWIKOO.EL_ID"
	              );
	            }

	            var options = {
	              envId: config.envId,
	              el: "#" + config.elId,
	            };
	            if (config.region) options.region = config.region;
	            if (config.lang) options.lang = config.lang;
	            if (config.path) options.path = config.path;

	            var initFn =
	              (typeof tw.init === "function" && tw.init) ||
	              (typeof tw.default === "function" && tw.default) ||
	              (typeof tw === "function" && tw);

	            if (typeof initFn !== "function") {
	              throw new Error(
	                "Invalid twikoo export: " +
	                  Object.prototype.toString.call(tw) +
	                  ", init=" +
	                  typeof tw.init +
	                  ", default=" +
	                  typeof tw.default
	              );
	            }

	            await Promise.resolve(initFn(options));
	            mountEl.dataset.twikooMounted = "1";
	            mountEl.dataset.twikooMounting = "0";
	            setStatus("");
	          } catch (err) {
	            mountEl.dataset.twikooMounting = "0";
	            setStatus("评论加载失败，请检查浏览器控制台/网络请求");
	            if (err && typeof console !== "undefined") console.error(err);
	          }
	        }

        if (!window.__twikooAstro.hooked) {
          window.__twikooAstro.hooked = true;
          document.addEventListener("astro:page-load", initTwikoo);
          document.addEventListener("DOMContentLoaded", initTwikoo);
        }
      })();
    </script>
  </section>
)}
